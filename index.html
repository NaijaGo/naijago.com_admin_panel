<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NaijaGo Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <!-- Using local Tailwind CSS to avoid CDN warning -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /* Your complete original styles â€“ unchanged      */
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --primary-blue: #0A192F;
            --secondary-blue: #1C2B47;
            --accent-cyan: #64FFDA;
            --light-slate: #CCD6F6;
            --light-gray: #A8B2D1;
            --red-pastel: #F87171;
            --green-pastel: #34D399;
            --yellow-pastel: #FBBF24;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-blue);
            color: var(--light-slate);
            transition: background-color 0.5s ease-in-out;
        }

        .container {
            max-width: 1200px;
            background-color: var(--secondary-blue);
            padding: 3rem 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: fade-in 1s ease-in-out;
        }

        .card {
            background-color: var(--primary-blue);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn {
            font-weight: 600;
            border-radius: 8px;
            transition: transform 0.2s ease, background-color 0.3s ease;
            text-transform: uppercase;
        }
        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: var(--accent-cyan);
            color: var(--primary-blue);
        }
        .btn-primary:hover {
            background-color: #52e3c3;
        }

        .btn-success {
            background-color: var(--green-pastel);
            color: white;
        }
        .btn-success:hover {
            background-color: #27c181;
        }

        .btn-warning {
            background-color: var(--yellow-pastel);
            color: white;
        }
        .btn-warning:hover {
            background-color: #f59e0b;
        }

        .btn-danger {
            background-color: var(--red-pastel);
            color: white;
        }
        .btn-danger:hover {
            background-color: #e45b5b;
        }

        .btn-shipped, .btn-delivered, .btn-resolved {
            border-radius: 20px;
            font-weight: 500;
            padding: 8px 20px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-shipped { background-color: #3b82f6; }
        .btn-delivered, .btn-resolved { background-color: #10b981; }

        .btn-shipped:hover:not(:disabled) { background-color: #2563eb; }
        .btn-delivered:hover:not(:disabled), .btn-resolved:hover:not(:disabled) { background-color: #059669; }

        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .input-field {
            background-color: var(--secondary-blue);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--light-slate);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }
        .input-field::placeholder {
            color: var(--light-gray);
        }

        #orderFilterDropdown {
            appearance: none;
            background-color: var(--primary-blue);
            border: 1px solid var(--accent-cyan);
            color: var(--light-slate);
            padding: 10px 30px 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364FFDA' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: border-color 0.3s;
        }
        #orderFilterDropdown:hover {
            border-color: #52e3c3;
        }

        .message {
            padding: 16px;
            border-radius: 12px;
            margin-top: 1.5rem;
            font-weight: 500;
            animation: slide-down 0.5s ease-out;
        }
        .message.success {
            background-color: rgba(52, 211, 153, 0.2);
            color: var(--green-pastel);
        }
        .message.error {
            background-color: rgba(248, 113, 129, 0.2);
            color: var(--red-pastel);
        }
        .message.warning {
            background-color: rgba(251, 191, 36, 0.2);
            color: var(--yellow-pastel);
        }

        .order-card, .dispute-card, .request-card, .rider-card {
            margin-bottom: 2rem;
            padding: 2rem;
        }

        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-y-8 > * + * { margin-top: 2rem; }

        .chat-container {
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 12px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            background-color: rgba(100, 255, 218, 0.05);
            margin-bottom: 1.5rem;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 10px 16px;
            border-radius: 16px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slide-in 0.4s ease-out;
        }
        .chat-message.admin {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-message.user {
            background-color: #4B5563;
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .dispute-attachments img {
            max-width: 150px;
            border-radius: 8px;
            margin-right: 12px;
            margin-bottom: 12px;
            transition: transform 0.3s ease;
        }
        .dispute-attachments img:hover {
            transform: scale(1.05);
        }

        .status-btn {
            transition: all 0.2s;
            border-radius: 0.25rem;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .status-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary-alt { background-color: #2c5282; color: #edf2f7; }
        .btn-success { background-color: #38a169; color: white; }
        .btn-warning { background-color: #d97706; color: white; }
        .btn-danger { background-color: #e53e3e; color: white; }
        .btn-disabled {
            background-color: #4a5568 !important;
            color: #a0aec0 !important;
            cursor: not-allowed !important;
            pointer-events: none;
            opacity: 0.6;
        }
        .btn-current {
            background-color: #4299e1;
            color: white;
            font-weight: bold;
            border: 2px solid #63b3ed;
            cursor: default;
        }
        .btn-current:hover { transform: none; }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .shimmer-text {
            background: linear-gradient(90deg, #1C2B47, #3b82f6, #1C2B47);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s infinite linear;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slide-down {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slide-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track {
            background: var(--secondary-blue);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 10px;
        }

        /* Accordion header style */
        .accordion-header {
            cursor: pointer;
            user-select: none;
        }
        .accordion-header::after {
            content: 'â–¼';
            float: right;
            transition: transform 0.3s;
        }
        .accordion-header.active::after {
            transform: rotate(180deg);
        }

        /* Rider status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending { background-color: #fbbf24; color: #78350f; }
        .status-approved { background-color: #10b981; color: #064e3b; }
        .status-rejected { background-color: #ef4444; color: #7f1d1d; }
        .status-suspended { background-color: #6b7280; color: #111827; }
        .status-delivered { background-color: #3b82f6; color: #1e40af; }
        .status-completed { background-color: #8b5cf6; color: #5b21b6; }
        
        /* Payout card */
        .payout-card {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent);
        }
        .pending-payout-card {
            border-left: 4px solid #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), transparent);
        }
        
        /* Real-time tracking */
        .tracking-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .tracking-active { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .tracking-inactive { background-color: #6b7280; }
        .tracking-moving { background-color: #3b82f6; box-shadow: 0 0 10px #3b82f6; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Animation for notifications */
        .animate-slide-in {
            animation: slide-in 0.5s ease-out;
        }
    </style>
</head>
<body class="p-8">

<div class="container mx-auto">

    <h1 class="text-5xl font-extrabold text-center text-light-slate mb-10 shimmer-text">
        NaijaGo Admin Panel
    </h1>

    <div class="bg-blue-800 bg-opacity-30 border-l-4 border-accent-cyan text-light-slate p-5 rounded-lg mb-8" role="alert">
        <p class="font-bold">Admin Authentication</p>
        <p class="text-sm">Welcome Admin to this interface. Please log in to manage data.</p>
    </div>

    <div class="mb-12 p-8 card">
        <label for="adminEmail" class="block text-light-gray text-sm font-semibold mb-2">Admin Email:</label>
        <input type="email" id="adminEmail" class="input-field w-full mb-6" placeholder="Enter admin email" />
        <label for="adminPassword" class="block text-light-gray text-sm font-semibold mb-2">Admin Password:</label>
        <input type="password" id="adminPassword" class="input-field w-full mb-6" placeholder="Enter admin password" />
        <button id="loginAdminBtn" class="btn btn-primary w-full py-3 rounded-lg text-lg">Login as Admin</button>
    </div>

    <div id="messageContainer" class="mb-4"></div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- Pending Vendor Requests â€“ always visible       -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <h2 class="text-4xl font-bold text-accent-cyan mb-8">Pending Vendor Requests</h2>
    <div id="pendingRequestsList" class="space-y-8 mb-16">
        <p class="text-center text-light-gray">Login to load requests...</p>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- Green Action Buttons Section                   -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="mb-10 flex flex-col md:flex-row gap-4">
        <button id="toggleCompaniesBtn" class="btn btn-primary flex-1 py-4 text-lg font-bold flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Company Management
        </button>
        
        <button id="toggleOrdersBtn" class="btn btn-success flex-1 py-4 text-lg font-bold flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            See Orders
        </button>
        
        <button id="toggleDisputesBtn" class="btn btn-success flex-1 py-4 text-lg font-bold flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            Settle Disputes
        </button>
        
        <button id="toggleWithdrawalsBtn" class="btn btn-warning flex-1 py-4 text-lg font-bold flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Pending Withdrawals
            <span id="withdrawalCountBadge" class="text-sm bg-white text-yellow-800 px-3 py-1 rounded-full">0</span>
        </button>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- Companies Section (hidden by default)         -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="companiesSection" class="hidden mt-6">
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-3xl font-bold text-accent-cyan">Company Management</h2>
            <div class="flex items-center gap-4">
                <button id="refreshCompaniesBtn" class="btn btn-primary px-4 py-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- Company Filter -->
        <div class="mb-6 flex flex-wrap gap-2">
            <button class="company-filter-btn btn btn-primary-alt px-4 py-2 text-sm" data-status="all">All Companies</button>
            <button class="company-filter-btn btn px-4 py-2 text-sm status-approved" data-status="active">Active</button>
            <button class="company-filter-btn btn px-4 py-2 text-sm status-pending" data-status="pending">Pending</button>
            <button class="company-filter-btn btn px-4 py-2 text-sm status-suspended" data-status="suspended">Suspended</button>
        </div>
        
        <div id="companiesList" class="space-y-6">
            <p class="text-center text-light-gray">Click "Company Management" to load companies...</p>
        </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- Orders Section (hidden by default)             -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="ordersSection" class="hidden mt-6">
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-3xl font-bold text-accent-cyan">Order Management</h2>
            <div class="filter-controls flex items-center space-x-3">
                <label for="orderFilterDropdown" class="text-light-gray font-medium">Filter by Status:</label>
                <select id="orderFilterDropdown" class="bg-[#1C2B47] border border-accent-cyan text-light-slate px-3 py-2 rounded-lg">
                    <option value="all">All Orders</option>
                    <option value="pending_payment">Pending Payment</option>
                    <option value="processing">Processing</option>
                    <option value="out_for_delivery">Out for Delivery</option>
                    <option value="delivered">Delivered (Ready for Payout)</option>
                    <option value="completed">Completed (Paid)</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>
        <div id="ordersList" class="space-y-8">
            <p class="text-center text-light-gray">Click "See Orders" to load orders...</p>
        </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- Disputes Section (hidden by default)           -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="disputesSection" class="hidden mt-6">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-accent-cyan">Disputes</h2>
        </div>
        <div id="disputesList" class="space-y-8">
            <p class="text-center text-light-gray">Click "Settle Disputes" to load disputes...</p>
        </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- Withdrawals Section (hidden by default)        -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="withdrawalsSection" class="hidden mt-6">
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-3xl font-bold text-accent-cyan">Pending Withdrawals</h2>
            <div class="flex items-center gap-4">
                <span id="withdrawalTotalDisplay" class="text-lg text-light-gray">Total Pending: â‚¦0</span>
                <button id="refreshWithdrawalsBtn" class="btn btn-primary px-4 py-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- Withdrawal Type Filter -->
        <div class="mb-6 flex flex-wrap gap-2">
            <button class="withdrawal-filter-btn btn btn-primary-alt px-4 py-2 text-sm" data-type="all">All Withdrawals</button>
            <button class="withdrawal-filter-btn btn btn-warning px-4 py-2 text-sm" data-type="pending">Pending</button>
            <button class="withdrawal-filter-btn btn btn-success px-4 py-2 text-sm" data-type="completed">Completed</button>
            <button class="withdrawal-filter-btn btn btn-danger px-4 py-2 text-sm" data-type="failed">Failed</button>
            <button class="withdrawal-filter-btn btn px-4 py-2 text-sm" data-type="vendor">Vendor Withdrawals</button>
            <button class="withdrawal-filter-btn btn px-4 py-2 text-sm" data-type="rider">Rider Withdrawals</button>
        </div>
        
        <div id="withdrawalsList" class="space-y-6">
            <p class="text-center text-light-gray">Click "Pending Withdrawals" to load withdrawal requests...</p>
        </div>
    </div>

</div>

<script>
// Wrap everything in DOMContentLoaded for safety
document.addEventListener('DOMContentLoaded', () => {
    const BASE_URL = 'https://naijago-backend.onrender.com';
    //const BASE_URL = 'http://localhost:5000'; 

    let adminToken = '';
    let currentFilter = 'all';
    let currentRiderFilter = 'all';
    let currentWithdrawalFilter = 'all';
    let currentCompanyFilter = 'all';
    let allOrders = [];
    let allRiders = [];
    let allWithdrawals = [];
    let allCompanies = [];

    // DOM Elements - only get those that exist
    const messageContainer     = document.getElementById('messageContainer');
    const pendingRequestsList  = document.getElementById('pendingRequestsList');
    const adminEmailInput      = document.getElementById('adminEmail');
    const adminPasswordInput   = document.getElementById('adminPassword');
    const loginAdminBtn        = document.getElementById('loginAdminBtn');

    const ordersList           = document.getElementById('ordersList');
    const orderFilterDropdown  = document.getElementById('orderFilterDropdown');

    const disputesList         = document.getElementById('disputesList');

    const withdrawalsList      = document.getElementById('withdrawalsList');
    const withdrawalCountBadge = document.getElementById('withdrawalCountBadge');
    const withdrawalTotalDisplay = document.getElementById('withdrawalTotalDisplay');
    const refreshWithdrawalsBtn = document.getElementById('refreshWithdrawalsBtn');

    // Initialize Socket.io connection for real-time updates
    let socket = null;
    function initializeSocket() {
        if (!adminToken) return;
        
        socket = io(BASE_URL, {
            auth: { token: adminToken },
            transports: ['websocket', 'polling']
        });

        socket.on('connect', () => {
            console.log('Connected to real-time server');
        });

        socket.on('admin_notification', (data) => {
            showRealTimeNotification(data);
        });

        socket.on('rider_location_update', (data) => {
            updateRiderLocationOnMap(data);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from real-time server');
        });
    }

    function showRealTimeNotification(data) {
        const notificationDiv = document.createElement('div');
        notificationDiv.className = 'fixed top-4 right-4 z-50 card p-4 max-w-sm animate-slide-in';
        notificationDiv.style.minWidth = '300px';
        
        let icon = 'ğŸ“¢';
        let bgColor = 'bg-blue-900';
        if (data.type === 'order_ready_for_completion') {
            icon = 'ğŸ’°';
            bgColor = 'bg-green-900';
        } else if (data.type === 'rider_withdrawal_request') {
            icon = 'ğŸ§';
            bgColor = 'bg-yellow-900';
        } else if (data.type === 'delivery_cancelled') {
            icon = 'âŒ';
            bgColor = 'bg-red-900';
        }
        
        notificationDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <span class="text-2xl">${icon}</span>
                <div class="flex-1">
                    <h4 class="font-bold text-accent-cyan">${data.type?.replace(/_/g, ' ').toUpperCase() || 'Notification'}</h4>
                    <p class="text-sm mt-1">${data.message}</p>
                    <p class="text-xs text-gray-400 mt-2">${new Date().toLocaleTimeString()}</p>
                </div>
                <button class="text-gray-400 hover:text-white" onclick="this.parentElement.parentElement.remove()">Ã—</button>
            </div>
        `;
        
        document.body.appendChild(notificationDiv);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notificationDiv.parentNode) {
                notificationDiv.remove();
            }
        }, 10000);
    }

    function updateRiderLocationOnMap(data) {
        console.log('Rider location updated:', data);
        const riderCards = document.querySelectorAll(`[data-rider-id="${data.riderId}"]`);
        riderCards.forEach(card => {
            const locationEl = card.querySelector('.rider-location');
            if (locationEl) {
                locationEl.innerHTML = `
                    <span class="tracking-dot tracking-moving"></span>
                    Live: ${data.location.lat.toFixed(4)}, ${data.location.lng.toFixed(4)}
                `;
                locationEl.title = data.location.address || 'Location updated just now';
            }
        });
    }

    function displayMessage(message, type) {
        messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
        setTimeout(() => { messageContainer.innerHTML = ''; }, 6000);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Vendor Requests (always visible)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchPendingVendorRequests() {
        if (!adminToken) {
            pendingRequestsList.innerHTML = '<p class="text-center text-light-gray">Please login as admin to load requests.</p>';
            return;
        }
        pendingRequestsList.innerHTML = '<p class="text-center text-light-gray">Loading pending requests...</p>';
        try {
            const res = await fetch(`${BASE_URL}/api/admin/vendor-requests`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const data = await res.json();
            if (res.ok) {
                renderPendingRequests(data);
            } else {
                displayMessage(data.message || 'Failed to fetch requests', 'error');
                pendingRequestsList.innerHTML = '<p class="text-center text-red-500">Error loading requests</p>';
            }
        } catch (err) {
            displayMessage(`Network error: ${err.message}`, 'error');
            pendingRequestsList.innerHTML = '<p class="text-center text-red-500">Connection failed</p>';
        }
    }

    function renderPendingRequests(requests) {
        pendingRequestsList.innerHTML = '';
        if (!requests?.length) {
            pendingRequestsList.innerHTML = '<p class="text-center text-light-gray">No pending vendor requests.</p>';
            return;
        }
        requests.forEach(r => {
            const card = document.createElement('div');
            card.className = 'card p-6 request-card';
            card.innerHTML = `
                <h3 class="text-xl font-semibold text-accent-cyan mb-2">${r.firstName} ${r.lastName}</h3>
                <p class="text-light-gray text-sm mb-1"><strong>Email:</strong> ${r.email}</p>
                <p class="text-light-gray text-sm mb-1"><strong>Phone:</strong> ${r.phoneNumber}</p>
                <p class="text-light-gray text-sm mb-1"><strong>Business:</strong> ${r.businessName || 'N/A'}</p>
                <p class="text-light-gray text-sm mb-4"><strong>Categories:</strong> ${r.businessCategories?.join(', ') || 'N/A'}</p>
                <p class="text-light-gray text-sm mb-4"><strong>Status:</strong> <span class="text-orange-400 font-bold">${r.vendorStatus?.toUpperCase() || 'NONE'}</span></p>
                <div class="flex justify-end gap-4 mt-4">
                    <button class="btn btn-success px-6 py-2 approve-btn" data-user-id="${r._id}">Approve</button>
                    <button class="btn btn-danger px-6 py-2 reject-btn" data-user-id="${r._id}">Reject</button>
                </div>
            `;
            pendingRequestsList.appendChild(card);
        });
        document.querySelectorAll('.approve-btn').forEach(b => b.onclick = () => updateVendorStatus(b.dataset.userId, 'approved'));
        document.querySelectorAll('.reject-btn').forEach(b => b.onclick = () => updateVendorStatus(b.dataset.userId, 'rejected'));
    }

    async function updateVendorStatus(userId, status) {
        try {
            const res = await fetch(`${BASE_URL}/api/admin/vendor-status/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status })
            });
            const data = await res.json();
            if (res.ok) {
                displayMessage(`Request ${status}!`, 'success');
                fetchPendingVendorRequests();
            } else {
                displayMessage(data.message || 'Failed to update status', 'error');
            }
        } catch (err) {
            displayMessage(`Error: ${err.message}`, 'error');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Orders Management â€“ Enhanced with payout system
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchOrders() {
        if (!adminToken) {
            ordersList.innerHTML = '<p class="text-center text-red-500">Please login as admin to view orders.</p>';
            return;
        }
        ordersList.innerHTML = '<p class="text-center text-light-gray">Loading orders...</p>';
        try {
            const res = await fetch(`${BASE_URL}/api/orders`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const data = await res.json();
            if (res.ok) {
                allOrders = data;
                renderOrders(applyFilter(allOrders));
            } else {
                ordersList.innerHTML = `<p class="text-center text-red-500">${data.message || 'Failed to fetch orders'}</p>`;
            }
        } catch (err) {
            ordersList.innerHTML = `<p class="text-center text-red-500">Network error: ${err.message}</p>`;
        }
    }

    function applyFilter(orders) {
        if (currentFilter === 'all') return orders;
        return orders.filter(o => o.mainOrderStatus === currentFilter);
    }

    function renderOrders(orders) {
        ordersList.innerHTML = '';
        if (!orders.length) {
            ordersList.innerHTML = '<p class="text-center text-light-gray">No orders found matching the filter criteria.</p>';
            return;
        }

        orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'card order-card';
            
            if (order.mainOrderStatus === 'delivered') {
                card.classList.add('pending-payout-card');
            } else if (order.mainOrderStatus === 'completed') {
                card.classList.add('payout-card');
            }

            const user = order.user || {};
            const shipping = order.shippingAddress || {};
            const rider = order.rider ? { _id: order.rider } : null;

            const statusLower = (order.mainOrderStatus || 'pending_payment').toLowerCase();
            
            // Calculate potential rider payout (150/km per shipment)
            let totalRiderPayout = 0;
            let totalVendorPayout = 0;
            
            if (order.shipments?.length) {
                order.shipments.forEach(shipment => {
                    if (shipment.vendorLocation && order.userLocation) {
                        const distance = calculateDistance(
                            shipment.vendorLocation.latitude,
                            shipment.vendorLocation.longitude,
                            order.userLocation.latitude,
                            order.userLocation.longitude
                        );
                        totalRiderPayout += distance * 150;
                    }
                    // Vendor gets subtotal - platformFee
                    totalVendorPayout += (shipment.subtotal || 0) - (shipment.platformFee || 0);
                });
            }

            let itemsHtml = '';
            if (order.shipments?.length) {
                order.shipments.forEach((s, i) => {
                    const v = s.vendor || {};
                    itemsHtml += `
                        <h4 class="text-sm font-semibold mt-4 mb-2 text-accent-cyan border-b border-gray-700 pb-1">
                            ğŸ“¦ Shipment ${i+1} (Vendor: ${v.businessName || 'N/A'})
                        </h4>
                        <p class="text-xs text-light-gray mb-1 ml-2">
                            Vendor Phone: ${v.phoneNumber || 'N/A'} | Location: ${v.businessLocation?.formattedAddress || 'N/A'}
                        </p>
                        <p class="text-xs text-yellow-400 mb-2 ml-2">
                            Vendor Payout: â‚¦${((s.subtotal || 0) - (s.platformFee || 0)).toFixed(2)} | Platform Fee: â‚¦${(s.platformFee || 0).toFixed(2)}
                        </p>`;
                    s.items?.forEach(item => {
                        let sizeDisplay = '';
                        if (item.selectedSize) {
                            if (typeof item.selectedSize === 'string') {
                                sizeDisplay = `Size: ${item.selectedSize}`;
                            } else if (typeof item.selectedSize === 'object') {
                                const sizeObj = item.selectedSize;
                                if (sizeObj.label) {
                                    sizeDisplay = `Size: ${sizeObj.label}`;
                                    if (sizeObj.length || sizeObj.width || sizeObj.height) {
                                        const unit = sizeObj.unit || 'CM';
                                        sizeDisplay += ` (${sizeObj.length || '0'}Ã—${sizeObj.width || '0'}Ã—${sizeObj.height || '0'} ${unit})`;
                                    }
                                } else if (sizeObj.length || sizeObj.width || sizeObj.height) {
                                    const unit = sizeObj.unit || 'CM';
                                    sizeDisplay = `Dimensions: ${sizeObj.length || '0'}Ã—${sizeObj.width || '0'}Ã—${sizeObj.height || '0'} ${unit}`;
                                } else {
                                    sizeDisplay = 'Custom Size';
                                }
                            }
                        }
                        
                        itemsHtml += `
                            <li class="text-light-gray mb-2 border-l-2 border-green-500 pl-2 ml-2">
                                <strong class="text-light-slate">${item.name}</strong> - Qty: ${item.quantity} - â‚¦${item.price?.toFixed(2) || '0.00'}
                                ${sizeDisplay ? `<br><span class="text-xs text-accent-cyan font-medium">${sizeDisplay}</span>` : ''}
                                <br><span class="text-xs text-gray-500">Shipment ID: ${s._id} | Status: ${s.shipmentStatus}</span>
                            </li>`;
                    });
                });
            } else {
                itemsHtml = '<p class="text-red-500">No shipments linked to this order.</p>';
            }

            const currentStatus = statusLower;

            const isDisabled = (target) => {
                switch (currentStatus) {
                    case 'completed': case 'cancelled': return true;
                    case 'delivered': return !['completed','cancelled'].includes(target);
                    case 'out_for_delivery': return !['delivered','completed','cancelled'].includes(target);
                    case 'shipped': return !['out_for_delivery','delivered','completed','cancelled'].includes(target);
                    case 'partially_shipped': return !['shipped','out_for_delivery','delivered','completed','cancelled'].includes(target);
                    case 'processing': return !['partially_shipped','shipped','out_for_delivery','delivered','completed','cancelled'].includes(target);
                    case 'pending_payment': return !['processing','cancelled'].includes(target);
                    default: return !['pending_payment','processing','cancelled'].includes(target);
                }
            };

            const getBtnClass = (target) => {
                let cls = 'status-btn px-3 py-1 text-sm font-medium';
                if (target === currentStatus) return `${cls} btn-current`;
                if (isDisabled(target)) return `${cls} btn-disabled`;
                if (target === 'cancelled') return `${cls} btn-danger`;
                if (target === 'completed') return `${cls} btn-success`;
                if (target === 'delivered') return `${cls} btn-warning`;
                return `${cls} btn-primary-alt`;
            };

            const btns = `
                <button class="${getBtnClass('pending_payment')}" ${isDisabled('pending_payment')?'disabled':''} data-order-id="${order._id}" data-status="pending_payment">Pending Payment</button>
                <button class="${getBtnClass('processing')}" ${isDisabled('processing')?'disabled':''} data-order-id="${order._id}" data-status="processing">Processing</button>
                <button class="${getBtnClass('partially_shipped')}" ${isDisabled('partially_shipped')?'disabled':''} data-order-id="${order._id}" data-status="partially_shipped">Partially Shipped</button>
                <button class="${getBtnClass('shipped')}" ${isDisabled('shipped')?'disabled':''} data-order-id="${order._id}" data-status="shipped">Shipped</button>
                <button class="${getBtnClass('out_for_delivery')}" ${isDisabled('out_for_delivery')?'disabled':''} data-order-id="${order._id}" data-status="out_for_delivery">Out for Delivery</button>
                <button class="${getBtnClass('delivered')}" ${isDisabled('delivered')?'disabled':''} data-order-id="${order._id}" data-status="delivered">Mark Delivered</button>
                <button class="${getBtnClass('completed')}" ${isDisabled('completed')?'disabled':''} data-order-id="${order._id}" data-status="completed">Complete & Pay</button>
                <button class="${getBtnClass('cancelled')}" ${isDisabled('cancelled')?'disabled':''} data-order-id="${order._id}" data-status="cancelled">Cancel</button>
            `;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-2xl font-semibold text-accent-cyan">Order ID: ${order._id}</h3>
                    ${order.rider ? `<span class="status-badge status-delivered">Rider Assigned</span>` : ''}
                </div>
                <p class="text-light-gray mb-1"><strong>User:</strong> ${user.firstName||'N/A'} ${user.lastName||''} (<span class="text-accent-cyan">${user.email||'N/A'}</span>)</p>
                <p class="text-light-gray mb-1"><strong>Phone:</strong> ${user.phoneNumber||'N/A'}</p>
                <p class="text-light-gray mb-1"><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString('en-US',{dateStyle:'medium',timeStyle:'short'})}</p>
                <p class="text-light-gray mb-1"><strong>Paid:</strong> <span class="font-bold ${order.isPaid?'text-green-400':'text-red-400'}">${order.isPaid?'Yes':'No'}</span></p>
                ${rider ? `<p class="text-light-gray mb-1"><strong>Rider:</strong> ${order.riderName || 'Assigned'} (${order.riderPhone || 'No phone'})</p>` : ''}
                
                <!-- Payout Information Box -->
                ${order.mainOrderStatus === 'delivered' || order.mainOrderStatus === 'completed' ? `
                <div class="${order.mainOrderStatus === 'delivered' ? 'bg-yellow-900 bg-opacity-30' : 'bg-green-900 bg-opacity-30'} p-4 rounded-lg my-4 border ${order.mainOrderStatus === 'delivered' ? 'border-yellow-700' : 'border-green-700'}">
                    <h4 class="font-bold ${order.mainOrderStatus === 'delivered' ? 'text-yellow-300' : 'text-green-300'} mb-2">
                        ${order.mainOrderStatus === 'delivered' ? 'ğŸ’° READY FOR PAYOUT' : 'âœ… PAYOUT COMPLETED'}
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-300">Total Vendor Payout:</p>
                            <p class="text-xl font-bold ${order.mainOrderStatus === 'delivered' ? 'text-yellow-300' : 'text-green-300'}">â‚¦${totalVendorPayout.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-300">Total Rider Payout:</p>
                            <p class="text-xl font-bold ${order.mainOrderStatus === 'delivered' ? 'text-yellow-300' : 'text-green-300'}">â‚¦${totalRiderPayout.toFixed(2)}</p>
                        </div>
                    </div>
                    ${order.mainOrderStatus === 'delivered' ? `
                    <p class="text-xs text-yellow-200 mt-2">Click "Complete & Pay" to process payouts to vendor(s) and rider simultaneously.</p>
                    ` : `
                    <p class="text-xs text-green-200 mt-2">Payouts completed on ${order.vendorPaidAt ? new Date(order.vendorPaidAt).toLocaleString() : new Date(order.deliveredAt).toLocaleString()}</p>
                    `}
                </div>
                ` : ''}
                
                <div class="mb-2"><strong>Status:</strong> <span class="font-bold text-lg ${order.mainOrderStatus === 'delivered' ? 'text-yellow-400' : order.mainOrderStatus === 'completed' ? 'text-green-400' : 'text-blue-400'}">${order.mainOrderStatus || 'N/A'}</span></div>
                <div class="mb-4">
                    <strong>Shipping Address:</strong><br>
                    <span class="text-light-gray">${shipping.address||'N/A'}, ${shipping.city||'N/A'}, ${shipping.postalCode||'N/A'}, ${shipping.country||'N/A'}</span>
                </div>
                <p class="text-light-slate text-xl font-bold mb-2">ğŸ›’ Items & Shipments:</p>
                <ul class="list-none mb-6">${itemsHtml}</ul>
                <div class="border-t border-gray-700 pt-4">
                    <h4 class="text-light-slate font-semibold mb-2">Update Status:</h4>
                    <div class="flex flex-wrap gap-2">${btns}</div>
                    <p class="text-xs text-light-gray mt-2">
                        â€¢ Enabled buttons follow valid order flow.<br>
                        â€¢ <strong class="text-yellow-400">"Mark Delivered"</strong> = Physical delivery confirmed.<br>
                        â€¢ <strong class="text-green-400">"Complete & Pay"</strong> = Process payouts to vendor(s) and rider simultaneously (150/km).<br>
                        â€¢ All payouts happen at once when status is changed to "completed".
                    </p>
                </div>
            `;
            
            ordersList.appendChild(card);
        });

        document.querySelectorAll('.status-btn:not(.btn-current):not(.btn-disabled)').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const orderId = btn.dataset.orderId;
                const newStatus = btn.dataset.status;
                const container = btn.closest('.flex.flex-wrap.gap-2');
                const siblings = container?.querySelectorAll('.status-btn') || [];

                siblings.forEach(b => b.disabled = true);

                try {
                    const res = await fetch(`${BASE_URL}/api/orders/${orderId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        if (newStatus === 'completed') {
                            displayMessage(`âœ… Order completed! Vendors and rider have been paid simultaneously.`, 'success');
                        } else {
                            displayMessage(`Status updated to ${newStatus.toUpperCase()}`, 'success');
                        }
                        fetchOrders();
                    } else {
                        displayMessage(data.message || 'Update failed', 'error');
                        siblings.forEach(b => b.disabled = false);
                    }
                } catch (err) {
                    displayMessage(`Network error`, 'error');
                    siblings.forEach(b => b.disabled = false);
                }
            });
        });
    }
   
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Disputes â€“ collapsible
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchDisputes() {
        if (!adminToken) {
            disputesList.innerHTML = '<p class="text-center text-red-500">Please login to view disputes.</p>';
            return;
        }
        disputesList.innerHTML = '<p class="text-center text-light-gray">Loading disputes...</p>';
        try {
            const res = await fetch(`${BASE_URL}/api/admin/disputes`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const data = await res.json();
            if (res.ok) {
                renderDisputes(data);
            } else {
                disputesList.innerHTML = `<p class="text-center text-red-500">${data.message || 'Failed to load disputes'}</p>`;
            }
        } catch (err) {
            disputesList.innerHTML = `<p class="text-center text-red-500">Network error</p>`;
        }
    }

    function renderDisputes(disputes) {
        disputesList.innerHTML = '';
        if (!disputes.length) {
            disputesList.innerHTML = '<p class="text-center text-light-gray">No disputes found.</p>';
            return;
        }

        disputes.forEach(d => {
            const card = document.createElement('div');
            card.className = 'card dispute-card';

            const attHtml = d.attachments?.length
                ? d.attachments.map(u => `<img src="${u}" alt="Attachment" class="inline-block">`).join('')
                : '<p class="text-gray-500">No attachments</p>';

            const msgHtml = (d.messages || []).map(m => {
                const name = m.senderType === 'Admin' ? 'Admin' : `${d.user?.firstName || 'User'} ${d.user?.lastName || ''}`;
                const align = m.senderType === 'Admin' ? 'ml-auto' : 'mr-auto';
                const bg = m.senderType === 'Admin' ? 'bg-blue-600' : 'bg-gray-600';
                return `<div class="chat-message ${align} ${bg}"><strong>${name}:</strong> ${m.text}</div>`;
            }).join('');

            const isResolved = d.status?.toLowerCase() === 'resolved';

            card.innerHTML = `
                <h3 class="text-2xl font-semibold text-accent-cyan mb-3">Dispute ID: ${d._id}</h3>
                <p class="mb-1"><strong>User:</strong> ${d.user?.firstName || 'N/A'} ${d.user?.lastName || ''} (<span class="text-accent-cyan">${d.user?.email || 'N/A'}</span>)</p>
                <p class="mb-1"><strong>Order ID:</strong> ${d.order?._id || 'N/A'}</p>
                <p class="mb-1"><strong>Status:</strong> <span class="font-bold text-lg text-red-400">${d.status}</span></p>
                <p class="mb-4"><strong>Reason:</strong> ${d.reason || 'N/A'}</p>
                <h4 class="font-semibold mt-4 mb-2">Attachments:</h4>
                <div class="dispute-attachments flex flex-wrap">${attHtml}</div>
                <h4 class="font-semibold mt-6 mb-3">Chat History:</h4>
                <div class="chat-container flex flex-col">${msgHtml}</div>
                <form class="send-message-form mt-4" data-dispute-id="${d._id}">
                    <textarea class="input-field w-full mb-3" rows="3" placeholder="Reply..."></textarea>
                    <button type="submit" class="btn btn-primary py-2 px-6">Send Reply</button>
                </form>
                <div class="mt-6">
                    <button class="btn btn-success ${isResolved ? 'opacity-50 cursor-not-allowed' : ''}" ${isResolved ? 'disabled' : ''} data-dispute-id="${d._id}" data-status="resolved">
                        Mark as Resolved
                    </button>
                </div>
            `;
            disputesList.appendChild(card);
        });

        document.querySelectorAll('.send-message-form').forEach(form => {
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const id = form.dataset.disputeId;
                const ta = form.querySelector('textarea');
                const text = ta.value.trim();
                if (!text) return;
                await sendDisputeMessage(id, text);
                ta.value = '';
            });
        });

        document.querySelectorAll('[data-dispute-id][data-status="resolved"]').forEach(btn => {
            btn.addEventListener('click', async () => {
                await updateDisputeStatus(btn.dataset.disputeId, 'resolved');
            });
        });
    }

    async function sendDisputeMessage(id, text) {
        try {
            const res = await fetch(`${BASE_URL}/api/admin/disputes/${id}/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ text })
            });
            if (res.ok) {
                displayMessage('Reply sent', 'success');
                fetchDisputes();
            } else {
                const data = await res.json();
                displayMessage(data.message || 'Failed to send reply', 'error');
            }
        } catch (err) {
            displayMessage('Network error', 'error');
        }
    }

    async function updateDisputeStatus(id, status) {
        try {
            const res = await fetch(`${BASE_URL}/api/admin/disputes/${id}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status })
            });
            if (res.ok) {
                displayMessage(`Dispute ${status}!`, 'success');
                fetchDisputes();
            } else {
                const data = await res.json();
                displayMessage(data.message || 'Failed', 'error');
            }
        } catch (err) {
            displayMessage('Network error', 'error');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Withdrawals Management
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchPendingWithdrawals() {
        if (!adminToken) {
            withdrawalsList.innerHTML = '<p class="text-center text-red-500">Please login to view withdrawals.</p>';
            return;
        }
        withdrawalsList.innerHTML = '<p class="text-center text-light-gray">Loading withdrawal requests...</p>';
        try {
            // Fetch vendor withdrawals
            const vendorRes = await fetch(`${BASE_URL}/api/admin/vendors/withdrawals`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            
            // Fetch rider withdrawals
            const riderRes = await fetch(`${BASE_URL}/api/admin/riders/withdrawals`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            
            let vendorWithdrawals = [];
            let riderWithdrawals = [];
            
            if (vendorRes.ok) {
                const data = await vendorRes.json();
                vendorWithdrawals = data.map(w => ({ ...w, type: 'vendor' }));
            }
            
            if (riderRes.ok) {
                const data = await riderRes.json();
                riderWithdrawals = data.map(w => ({ ...w, type: 'rider' }));
            }
            
            allWithdrawals = [...vendorWithdrawals, ...riderWithdrawals];
            
            // Calculate totals
            const pendingWithdrawals = allWithdrawals.filter(w => w.status === 'pending');
            const totalPending = pendingWithdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            
            if (withdrawalCountBadge) {
                withdrawalCountBadge.textContent = pendingWithdrawals.length;
            }
            if (withdrawalTotalDisplay) {
                withdrawalTotalDisplay.textContent = `Total Pending: â‚¦${totalPending.toFixed(2)}`;
            }
            
            renderWithdrawals(allWithdrawals);
            
        } catch (err) {
            withdrawalsList.innerHTML = `<p class="text-center text-red-500">Network error: ${err.message}</p>`;
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Company Management Functions
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchCompanies() {
        if (!adminToken) {
            document.getElementById('companiesList').innerHTML = '<p class="text-center text-red-500">Please login to view companies.</p>';
            return;
        }
        
        try {
            const res = await fetch(`${BASE_URL}/api/companyadmin/companies`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const data = await res.json();
            if (res.ok) {
                allCompanies = data;
                renderCompanies(data);
            } else {
                document.getElementById('companiesList').innerHTML = `<p class="text-center text-red-500">${data.message || 'Failed to load companies'}</p>`;
            }
        } catch (err) {
            document.getElementById('companiesList').innerHTML = `<p class="text-center text-red-500">Network error</p>`;
        }
    }

    function renderCompanies(companies) {
        const container = document.getElementById('companiesList');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Apply filter
        let filteredCompanies = companies;
        if (currentCompanyFilter !== 'all') {
            filteredCompanies = companies.filter(c => c.status === currentCompanyFilter);
        }
        
        if (!filteredCompanies.length) {
            container.innerHTML = '<p class="text-center text-light-gray">No companies found.</p>';
            return;
        }
        
        filteredCompanies.forEach(company => {
            const card = document.createElement('div');
            card.className = 'card p-6';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-accent-cyan">${company.companyName}</h3>
                        <p class="text-sm text-gray-400">RC: ${company.rcNumber || 'N/A'}</p>
                    </div>
                    <span class="status-badge ${company.status === 'active' ? 'status-approved' : company.status === 'pending' ? 'status-pending' : 'status-suspended'}">
                        ${company.status}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-400">Contact</p>
                        <p class="font-semibold">${company.contactPerson}</p>
                        <p class="text-xs text-gray-400">${company.email}</p>
                        <p class="text-xs text-gray-400">${company.phoneNumber}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Riders</p>
                        <p class="font-bold text-lg">${company.stats?.totalRiders || 0} total</p>
                        <p class="text-xs text-gray-400">${company.stats?.activeRiders || 0} active</p>
                    </div>
                </div>
                
                <div class="bg-gray-900 bg-opacity-50 p-3 rounded mb-4">
                    <p class="text-sm font-semibold text-gray-300 mb-2">Financials</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <p class="text-gray-400">Total Earnings</p>
                            <p class="font-bold text-green-400">â‚¦${(company.stats?.totalEarnings || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">Pending Settlement</p>
                            <p class="font-bold text-yellow-400">â‚¦${(company.stats?.pendingSettlement || 0).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center text-sm">
                    <div class="text-gray-400">
                        <p>Created: ${new Date(company.createdAt).toLocaleDateString()}</p>
                        ${company.lastLogin ? `<p>Last login: ${new Date(company.lastLogin).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary-alt px-3 py-1 text-sm view-company-btn" data-id="${company._id}">View</button>
                        <button class="btn btn-warning px-3 py-1 text-sm edit-company-btn" data-id="${company._id}">Edit</button>
                        ${company.status === 'active' ? 
                            `<button class="btn btn-danger px-3 py-1 text-sm suspend-company-btn" data-id="${company._id}">Suspend</button>` : 
                            `<button class="btn btn-success px-3 py-1 text-sm activate-company-btn" data-id="${company._id}">Activate</button>`
                        }
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
        
        // Add event listeners
        document.querySelectorAll('.view-company-btn').forEach(btn => {
            btn.addEventListener('click', () => viewCompanyDetails(btn.dataset.id));
        });
        
        document.querySelectorAll('.suspend-company-btn').forEach(btn => {
            btn.addEventListener('click', () => updateCompanyStatus(btn.dataset.id, 'suspended'));
        });
        
        document.querySelectorAll('.activate-company-btn').forEach(btn => {
            btn.addEventListener('click', () => updateCompanyStatus(btn.dataset.id, 'active'));
        });
        
        // Add company filter listeners
        document.querySelectorAll('.company-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentCompanyFilter = btn.dataset.status;
                document.querySelectorAll('.company-filter-btn').forEach(b => {
                    b.classList.remove('bg-accent-cyan', 'text-primary-blue');
                    b.classList.add('btn-primary-alt');
                });
                btn.classList.remove('btn-primary-alt');
                btn.classList.add('bg-accent-cyan', 'text-primary-blue');
                renderCompanies(allCompanies);
            });
        });
    }

    async function viewCompanyDetails(companyId) {
        try {
            const res = await fetch(`${BASE_URL}/api/admin/companies/${companyId}`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const company = await res.json();
            
            // Show modal with company details
            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-secondary-blue rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-accent-cyan">Company Details</h3>
                            <button class="text-gray-400 hover:text-white text-2xl" onclick="this.closest('.fixed').remove()">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-accent-cyan mb-2">Company Info</h4>
                                <p><strong>Name:</strong> ${company.companyName}</p>
                                <p><strong>Contact:</strong> ${company.contactPerson}</p>
                                <p><strong>Email:</strong> ${company.email}</p>
                                <p><strong>Phone:</strong> ${company.phoneNumber}</p>
                                <p><strong>Address:</strong> ${company.officeAddress}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-accent-cyan mb-2">Bank Details</h4>
                                ${company.bankAccount ? `
                                    <p><strong>Bank:</strong> ${company.bankAccount.bankName || 'N/A'}</p>
                                    <p><strong>Account:</strong> ${company.bankAccount.accountNumber || 'N/A'}</p>
                                    <p><strong>Name:</strong> ${company.bankAccount.accountName || 'N/A'}</p>
                                ` : '<p class="text-gray-400">No bank details provided</p>'}
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-semibold text-accent-cyan mb-2">Recent Settlements</h4>
                            <!-- Add settlement history here -->
                        </div>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        } catch (err) {
            displayMessage('Failed to load company details', 'error');
        }
    }

    async function updateCompanyStatus(companyId, status) {
        if (!confirm(`Are you sure you want to ${status} this company?`)) return;
        
        try {
            const res = await fetch(`${BASE_URL}/api/admin/companies/${companyId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status })
            });
            
            if (res.ok) {
                displayMessage(`Company ${status} successfully`, 'success');
                fetchCompanies();
            } else {
                const data = await res.json();
                displayMessage(data.message || 'Failed to update company', 'error');
            }
        } catch (err) {
            displayMessage('Network error', 'error');
        }
    }

    function renderWithdrawals(withdrawals) {
        if (!withdrawalsList) return;
        
        withdrawalsList.innerHTML = '';
        
        // Apply filter
        let filteredWithdrawals = withdrawals;
        if (currentWithdrawalFilter !== 'all') {
            if (currentWithdrawalFilter === 'vendor' || currentWithdrawalFilter === 'rider') {
                filteredWithdrawals = withdrawals.filter(w => w.type === currentWithdrawalFilter);
            } else {
                filteredWithdrawals = withdrawals.filter(w => w.status === currentWithdrawalFilter);
            }
        }
        
        if (!filteredWithdrawals.length) {
            withdrawalsList.innerHTML = '<p class="text-center text-light-gray">No withdrawal requests matching filter.</p>';
            return;
        }
        
        filteredWithdrawals.forEach(w => {
            const card = document.createElement('div');
            card.className = `card p-5 ${w.status === 'pending' ? 'pending-payout-card' : 'payout-card'}`;
            
            const userType = w.type === 'vendor' ? 'Vendor' : 'Rider';
            const userIcon = w.type === 'vendor' ? 'ğŸª' : 'ğŸï¸';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-accent-cyan">${userIcon} ${userType} Withdrawal</h3>
                        <p class="text-sm text-gray-400">Reference: ${w.reference || 'N/A'}</p>
                    </div>
                    <span class="status-badge ${w.status === 'pending' ? 'status-pending' : w.status === 'completed' ? 'status-approved' : 'status-rejected'}">
                        ${w.status}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-400">Amount</p>
                        <p class="text-2xl font-bold ${w.status === 'pending' ? 'text-yellow-400' : 'text-green-400'}">â‚¦${w.amount?.toFixed(2) || '0.00'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">User</p>
                        <p class="font-semibold">${w.userName || w.fullName || 'N/A'}</p>
                        <p class="text-xs text-gray-400">${w.email || 'N/A'}</p>
                    </div>
                </div>
                
                <div class="bg-gray-900 bg-opacity-50 p-3 rounded mb-4">
                    <p class="text-sm font-semibold text-gray-300 mb-2">Payment Details</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <p class="text-gray-400">Method</p>
                            <p>${w.paymentMethod || 'Bank Transfer'}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">Bank</p>
                            <p>${w.accountDetails?.bankName || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">Account No.</p>
                            <p>${w.accountDetails?.accountNumber || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">Account Name</p>
                            <p>${w.accountDetails?.accountName || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center text-sm text-gray-400">
                    <div>
                        <p>Requested: ${new Date(w.createdAt).toLocaleString()}</p>
                        ${w.completedAt ? `<p>Processed: ${new Date(w.completedAt).toLocaleString()}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${w.status === 'pending' ? `
                            <button class="btn btn-success px-4 py-2 text-sm process-withdrawal-btn" 
                                data-id="${w._id || w.reference}" 
                                data-type="${w.type}"
                                data-amount="${w.amount}">
                                Process
                            </button>
                            <button class="btn btn-danger px-4 py-2 text-sm reject-withdrawal-btn" 
                                data-id="${w._id || w.reference}"
                                data-type="${w.type}">
                                Reject
                            </button>
                        ` : ''}
                        ${w.status === 'completed' ? `
                            <button class="btn btn-primary-alt px-4 py-2 text-sm" disabled>
                                âœ… Processed
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            withdrawalsList.appendChild(card);
        });
        
        // Add event listeners
        document.querySelectorAll('.process-withdrawal-btn').forEach(btn => {
            btn.addEventListener('click', () => processWithdrawal(
                btn.dataset.id, 
                btn.dataset.type, 
                parseFloat(btn.dataset.amount)
            ));
        });
        
        document.querySelectorAll('.reject-withdrawal-btn').forEach(btn => {
            btn.addEventListener('click', () => rejectWithdrawal(btn.dataset.id, btn.dataset.type));
        });
        
        // Add withdrawal filter listeners
        document.querySelectorAll('.withdrawal-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentWithdrawalFilter = btn.dataset.type;
                document.querySelectorAll('.withdrawal-filter-btn').forEach(b => {
                    b.classList.remove('bg-accent-cyan', 'text-primary-blue');
                    b.classList.add('btn-primary-alt');
                });
                btn.classList.remove('btn-primary-alt');
                btn.classList.add('bg-accent-cyan', 'text-primary-blue');
                renderWithdrawals(allWithdrawals);
            });
        });
    }

    async function processWithdrawal(withdrawalId, userType, amount) {
        if (!confirm(`Process withdrawal of â‚¦${amount.toFixed(2)} for this ${userType}?`)) return;
        
        try {
            const endpoint = userType === 'vendor' 
                ? `${BASE_URL}/api/admin/vendors/withdrawals/${withdrawalId}/process`
                : `${BASE_URL}/api/admin/riders/withdrawals/${withdrawalId}/process`;
            
            const res = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status: 'completed' })
            });
            
            const data = await res.json();
            if (res.ok) {
                displayMessage(`Withdrawal processed successfully! â‚¦${amount.toFixed(2)} sent.`, 'success');
                fetchPendingWithdrawals();
            } else {
                displayMessage(data.message || 'Failed to process withdrawal', 'error');
            }
        } catch (err) {
            displayMessage(`Error: ${err.message}`, 'error');
        }
    }

    async function rejectWithdrawal(withdrawalId, userType) {
        const reason = prompt('Enter reason for rejection:');
        if (!reason) return;
        
        try {
            const endpoint = userType === 'vendor' 
                ? `${BASE_URL}/api/admin/vendors/withdrawals/${withdrawalId}/reject`
                : `${BASE_URL}/api/admin/riders/withdrawals/${withdrawalId}/reject`;
            
            const res = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ status: 'failed', reason })
            });
            
            const data = await res.json();
            if (res.ok) {
                displayMessage(`Withdrawal rejected.`, 'success');
                fetchPendingWithdrawals();
            } else {
                displayMessage(data.message || 'Failed to reject withdrawal', 'error');
            }
        } catch (err) {
            displayMessage(`Error: ${err.message}`, 'error');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Login & auto-load token
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (loginAdminBtn) {
        loginAdminBtn.addEventListener('click', async () => {
            const email = adminEmailInput.value.trim();
            const pw = adminPasswordInput.value.trim();
            if (!email || !pw) return displayMessage('Email and password required', 'error');

            try {
                const res = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password: pw, deviceFingerprint: 'web-admin' })
                });
                const data = await res.json();
                if (res.ok) {
                    adminToken = data.token;
                    localStorage.setItem('admin_jwt_token', data.token);
                    displayMessage('Logged in successfully', 'success');
                    adminEmailInput.value = adminPasswordInput.value = '';
                    
                    // Initialize socket connection
                    initializeSocket();
                    
                    // Load initial data
                    fetchPendingVendorRequests();
                } else {
                    displayMessage(data.message || 'Login failed', 'error');
                }
            } catch (err) {
                displayMessage(`Network error: ${err.message}`, 'error');
            }
        });
    }

    const storedToken = localStorage.getItem('admin_jwt_token');
    if (storedToken) {
        adminToken = storedToken;
        displayMessage('Session restored', 'success');
        initializeSocket();
        fetchPendingVendorRequests();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Green Button Toggles + lazy load
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('toggleCompaniesBtn')?.addEventListener('click', () => {
        const section = document.getElementById('companiesSection');
        section.classList.toggle('hidden');
        
        // Hide other sections when one is opened
        ['ordersSection', 'disputesSection', 'withdrawalsSection'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        
        if (!section.classList.contains('hidden')) {
            fetchCompanies();
        }
    });

    document.getElementById('toggleOrdersBtn')?.addEventListener('click', () => {
        const section = document.getElementById('ordersSection');
        section.classList.toggle('hidden');
        
        // Hide other sections when one is opened
        ['companiesSection', 'disputesSection', 'withdrawalsSection'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        
        if (!section.classList.contains('hidden') && allOrders.length === 0) {
            fetchOrders();
        }
    });

    document.getElementById('toggleDisputesBtn')?.addEventListener('click', () => {
        const section = document.getElementById('disputesSection');
        section.classList.toggle('hidden');
        
        // Hide other sections when one is opened
        ['companiesSection', 'ordersSection', 'withdrawalsSection'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        
        if (!section.classList.contains('hidden')) {
            fetchDisputes();
        }
    });

    document.getElementById('toggleWithdrawalsBtn')?.addEventListener('click', () => {
        const section = document.getElementById('withdrawalsSection');
        section.classList.toggle('hidden');
        
        // Hide other sections when one is opened
        ['companiesSection', 'ordersSection', 'disputesSection'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });
        
        if (!section.classList.contains('hidden')) {
            fetchPendingWithdrawals();
        }
    });

    // Refresh buttons
    document.getElementById('refreshCompaniesBtn')?.addEventListener('click', fetchCompanies);
    if (refreshWithdrawalsBtn) {
        refreshWithdrawalsBtn.addEventListener('click', fetchPendingWithdrawals);
    }

    // Filter change
    if (orderFilterDropdown) {
        orderFilterDropdown.addEventListener('change', e => {
            currentFilter = e.target.value;
            if (allOrders.length > 0) {
                renderOrders(applyFilter(allOrders));
            }
        });
    }

    // Helper function to calculate distance (same as backend)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in kilometers
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a = 
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c; // Distance in km
        return parseFloat(distance.toFixed(2));
    }

});
</script>
</body>
</html>
